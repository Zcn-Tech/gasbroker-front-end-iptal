<div class="
    absolute
    inset-0
    flex flex-col
    min-w-0
    overflow-hidden
    bg-card
    dark:bg-transparent
  ">
  <!-- Header -->
  <div class="
      relative
      flex flex-col
      sm:flex-row
      flex-0
      sm:items-center sm:justify-between
      py-8
      px-6
      md:px-8
      border-b
    ">
    <!-- Loader -->
    <div class="absolute inset-x-0 bottom-0" *ngIf="isLoading">
      <mat-progress-bar [mode]="'indeterminate'"></mat-progress-bar>
    </div>
    <!-- Title -->
    <div class="text-4xl font-extrabold tracking-tight">Products</div>
    <!-- Actions -->
    <div class="flex flex-shrink-0 items-center mt-6 sm:mt-0 sm:ml-4">
      <!-- Search -->
      <mat-form-field class="fuse-mat-dense fuse-mat-no-subscript min-w-50">
        <mat-icon matPrefix [svgIcon]="'heroicons_outline:search'"></mat-icon>
        <input matInput [formControl]="searchInputControl" [autocomplete]="'off'" [placeholder]="'Search products'" />
      </mat-form-field>
      <!--Add product button -->
      <button class="ml-4" mat-flat-button [color]="'primary'" (click)="createProduct()">
        <mat-icon [svgIcon]="'heroicons_outline:plus'"></mat-icon>
        <span class="ml-2 mr-1">Add</span>
      </button>
    </div>
  </div>
  <!-- Main -->
  <div class="flex flex-auto overflow-hidden">
    <!-- Products list -->
    <div class="flex flex-col flex-auto sm:mb-18 overflow-hidden">
      <ng-container *ngIf="productsCount > 0; else noProducts">
        <!-- Table wrapper -->
        <div class="overflow-x-auto sm:overflow-y-auto" cdkScrollable>
          <!-- Table -->
          <table class="w-full min-w-320 table-fixed bg-transparent" [ngClass]="{ 'pointer-events-none': isLoading }"
            mat-table matSort [matSortActive]="'name'" [matSortDisableClear]="true" [matSortDirection]="'asc'"
            [multiTemplateDataRows]="true" [dataSource]="products$" [trackBy]="trackByFn">
            <ng-container matColumnDef="code">
              <th class="w-56 pl-26 bg-gray-50 dark:bg-black dark:bg-opacity-5" mat-header-cell *matHeaderCellDef
                mat-sort-header disableClear>
                Product Code
              </th>
              <td class="px-8" mat-cell *matCellDef="let product">
                <div class="flex items-center">
                  <span class="
                      relative
                      flex flex-0
                      items-center
                      justify-center
                      w-12
                      h-12
                      mr-6
                      rounded
                      overflow-hidden
                      border
                    ">
                    <img class="w-8" *ngIf="product.thumbnail" [src]="product.thumbnail" />
                    <span class="
                        flex
                        items-center
                        justify-center
                        w-full
                        h-full
                        text-xs
                        font-semibold
                        leading-none
                        text-center
                        uppercase
                      " *ngIf="!product.thumbnail">
                      NO IMAGE
                    </span>
                  </span>
                  <span class="truncate">{{ product.code }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Name -->
            <ng-container matColumnDef="name">
              <th class="bg-gray-50 dark:bg-black dark:bg-opacity-5" mat-header-cell *matHeaderCellDef mat-sort-header
                disableClear>
                Product Name
              </th>
              <td class="pr-8 truncate" mat-cell *matCellDef="let product">
                {{ product.name }}
              </td>
            </ng-container>

            <!-- Code -->
            <ng-container matColumnDef="code2">
              <th class="bg-gray-50 dark:bg-black dark:bg-opacity-5" mat-header-cell *matHeaderCellDef mat-sort-header
                disableClear>
                Product Code
              </th>
              <td class="pr-8 truncate" mat-cell *matCellDef="let product">
                Product Code
              </td>
            </ng-container>

            <!-- Active -->
            <ng-container matColumnDef="active">
              <th class="
                  w-24
                  md:w-auto
                  bg-gray-50
                  dark:bg-black dark:bg-opacity-5
                " mat-header-cell *matHeaderCellDef mat-sort-header disableClear>
                Active
              </th>
              <td class="pr-4" mat-cell *matCellDef="let product">
                <mat-icon class="text-green-400 icon-size-5" *ngIf="product.active" [svgIcon]="'heroicons_solid:check'">
                </mat-icon>
                <mat-icon class="text-gray-400 icon-size-5" *ngIf="!product.active" [svgIcon]="'heroicons_solid:x'">
                </mat-icon>
              </td>
            </ng-container>

            <!-- Details -->
            <ng-container matColumnDef="details">
              <th class="
                  w-24
                  md:w-auto
                  pr-8
                  bg-gray-50
                  dark:bg-black dark:bg-opacity-5
                " mat-header-cell *matHeaderCellDef>
                Details
              </th>
              <td class="pr-8" mat-cell *matCellDef="let product">
                <button class="min-w-10 min-h-7 h-7 px-2 leading-6" mat-stroked-button
                  (click)="toggleDetails(product.id)">
                  <mat-icon class="icon-size-5" [svgIcon]="
                      selectedProduct?.id === product.id
                        ? 'heroicons_solid:chevron-up'
                        : 'heroicons_solid:chevron-down'
                    ">
                  </mat-icon>
                </button>
              </td>
            </ng-container>

            <!-- Product details row -->
            <ng-container matColumnDef="productDetails">
              <td class="p-0 border-b-0" mat-cell *matCellDef="let product"
                [attr.colspan]="productsTableColumns.length">
                <ng-container *ngIf="selectedProduct?.id === product.id">
                  <ng-container *ngTemplateOutlet="
                      rowDetailsTemplate;
                      context: { $implicit: product }
                    ">
                  </ng-container>
                </ng-container>
              </td>

              <ng-template #rowDetailsTemplate let-product>
                <div class="shadow-lg overflow-hidden" [@expandCollapse]="
                    selectedProduct?.id === product.id
                      ? 'expanded'
                      : 'collapsed'
                  ">
                  <div class="flex border-b">
                    <!-- Selected product form -->
                    <form class="flex flex-col w-full" [formGroup]="selectedProductForm">
                      <div class="flex p-8">
                        <!-- Product images and status -->
                        <div class="flex flex-col">
                          <div class="flex flex-col items-center">
                            <div class="p-3 border rounded">
                              <ng-container *ngIf="
                                  selectedProductForm?.get('images').value
                                    .length;
                                  else noImage
                                ">
                                <img class="w-30 min-w-30" [src]="
                                    selectedProductForm.get('images').value[
                                      selectedProductForm.get(
                                        'currentImageIndex'
                                      ).value
                                    ]
                                  " />
                              </ng-container>
                              <ng-template #noImage>
                                <span class="
                                    flex
                                    items-center
                                    min-h-20
                                    text-lg
                                    font-semibold
                                    text-center
                                    justify-center
                                  ">NO IMAGE</span>
                              </ng-template>
                            </div>
                            <div class="flex items-center mt-2" *ngIf="
                                selectedProductForm.get('images').value.length
                              ">
                              <button mat-icon-button (click)="cycleImages(false)">
                                <mat-icon class="icon-size-5" [svgIcon]="
                                    'heroicons_solid:arrow-narrow-left'
                                  "></mat-icon>
                              </button>
                              <span class="font-sm mx-2">
                                {{
                                selectedProductForm.get("currentImageIndex")
                                .value + 1
                                }}
                                of
                                {{
                                selectedProductForm.get("images").value.length
                                }}
                              </span>
                              <button mat-icon-button (click)="cycleImages(true)">
                                <mat-icon class="icon-size-5" [svgIcon]="
                                    'heroicons_solid:arrow-narrow-right'
                                  "></mat-icon>
                              </button>
                            </div>
                          </div>
                          <div class="flex flex-col mt-8">
                            <mat-slide-toggle [formControlName]="'active'" (click)="updateActive()" [color]="'primary'">
                              {{
                              selectedProductForm.get("active").value === true
                              ? "Active"
                              : "Disabled"
                              }}
                            </mat-slide-toggle>
                          </div>
                        </div>

                        <div class="flex flex-auto">
                          <div class="flex flex-col w-1/4 pl-8">
                            <mat-form-field class="w-full">
                              <mat-label>Code</mat-label>
                              <input matInput [formControlName]="'code'" />
                            </mat-form-field>
                            <mat-form-field class="w-full">
                              <mat-label>Name</mat-label>
                              <input matInput [formControlName]="'name'" />
                            </mat-form-field>
                            <button class="fuse-mat-button-rounded" (click)="openDetail(row)" mat-icon-button [color]="'primary'">
                              <mat-icon matPrefix class="hidden sm:flex icon-size-5"
                              [svgIcon]="'heroicons_outline:pencil-alt'" ></mat-icon>
                            </button>

                          </div>

                          <!-- Properties -->
                          <div class="flex flex-col w-1/4 pl-8">
                            <!-- Properties -->
                            <ng-container *ngIf="
                                selectedProduct ||
                                selectedProduct?.properties?.length
                              ">
                              <span class="font-semibold">Properties</span>
                              <div class="
                                  mt-1
                                  rounded-md
                                  border border-gray-300
                                  shadow-sm
                                  overflow-hidden
                                ">
                                <!-- Header -->
                                <div class="flex items-center my-2 mx-3">
                                  <div class="flex items-center flex-auto min-w-0">
                                    <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:search'">
                                    </mat-icon>
                                    <input class="min-w-0 ml-2 py-1 border-0" type="text"
                                      placeholder="Enter property name" (input)="filterProperties($event)" (keydown)="
                                        filterPropertiesInputKeyDown($event)
                                      " [maxLength]="50" #newPropertyInput />
                                  </div>
                                  <button class="ml-3 w-8 h-8 min-h-8" mat-icon-button
                                    (click)="togglePropertiesEditMode()">
                                    <mat-icon *ngIf="!propertiesEditMode" class="icon-size-5"
                                      [svgIcon]="'heroicons_solid:pencil-alt'">
                                    </mat-icon>
                                    <mat-icon *ngIf="propertiesEditMode" class="icon-size-5"
                                      [svgIcon]="'heroicons_solid:check'">
                                    </mat-icon>
                                  </button>
                                </div>
                                <!-- Available properties -->
                                <div class="
                                    max-h-40
                                    leading-none
                                    overflow-y-auto
                                    border-t
                                  ">
                                  <!-- properties -->
                                  <ng-container *ngIf="!propertiesEditMode">
                                    <ng-container *ngFor="
                                        let property of filteredProperties;
                                        trackBy: trackByFn
                                      ">
                                      <mat-checkbox class="
                                          flex
                                          items-center
                                          h-10
                                          min-h-10
                                          px-4
                                        " [color]="'primary'" [checked]="
                                          selectedProduct.properties.includes(
                                            property.id
                                          )
                                        " (change)="
                                          toggleProductProperty(
                                            property,
                                            $event
                                          )
                                        ">
                                        {{ property.name }}
                                      </mat-checkbox>
                                    </ng-container>
                                  </ng-container>
                                  <!-- Properties editing -->
                                  <ng-container *ngIf="propertiesEditMode">
                                    <div class="p-4 space-y-2">
                                      <ng-container *ngFor="
                                          let property of filteredProperties;
                                          trackBy: trackByFn
                                        ">
                                        <mat-form-field class="
                                            fuse-mat-dense fuse-mat-no-subscript
                                            w-full
                                          ">
                                          <input matInput [value]="property.name" (input)="
                                              updatePropertyName(
                                                property,
                                                $event
                                              )
                                            " />
                                          <button mat-icon-button (click)="deleteProperty(property)" matSuffix>
                                            <mat-icon class="icon-size-5" [svgIcon]="
                                                'heroicons_solid:trash'
                                              ">
                                            </mat-icon>
                                          </button>
                                        </mat-form-field>
                                      </ng-container>
                                    </div>
                                  </ng-container>
                                </div>
                                <div class="
                                    flex
                                    items-center
                                    h-10
                                    min-h-10
                                    -ml-0.5
                                    pl-4
                                    pr-3
                                    leading-none
                                    cursor-pointer
                                    border-t
                                    hover:bg-gray-50
                                    dark:hover:bg-hover
                                  " *ngIf="
                                    shouldShowCreatePropertyButton(
                                      newPropertyInput.value
                                    )
                                  " (click)="
                                    createProperty(newPropertyInput.value);
                                    newPropertyInput.value = ''
                                  " matRipple>
                                  <mat-icon class="mr-2 icon-size-5" [svgIcon]="'heroicons_solid:plus-circle'">
                                  </mat-icon>
                                  <div class="break-all">
                                    Create "<b>{{ newPropertyInput.value }}</b>"
                                  </div>
                                </div>
                              </div>
                            </ng-container>
                          </div>

                          <!-- Properties -->
                          <div class="flex flex-col w-1/4 pl-8">
                            <!-- Properties -->
                            <ng-container *ngIf="
                                selectedProduct ||
                                selectedProduct?.properties?.length
                              ">
                              <span class="font-semibold">Properties</span>
                              <div class="
                                  mt-1
                                  rounded-md
                                  border border-gray-300
                                  shadow-sm
                                  overflow-hidden
                                ">
                                <!-- Header -->
                                <div class="flex items-center my-2 mx-3">
                                  <div class="flex items-center flex-auto min-w-0">
                                    <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:search'">
                                    </mat-icon>
                                    <input class="min-w-0 ml-2 py-1 border-0" type="text"
                                      placeholder="Enter property name" (input)="filterProperties($event)" (keydown)="
                                        filterPropertiesInputKeyDown($event)
                                      " [maxLength]="50" #newPropertyInput />
                                  </div>
                                  <button class="ml-3 w-8 h-8 min-h-8" mat-icon-button
                                    (click)="togglePropertiesEditMode()">
                                    <mat-icon *ngIf="!propertiesEditMode" class="icon-size-5"
                                      [svgIcon]="'heroicons_solid:pencil-alt'">
                                    </mat-icon>
                                    <mat-icon *ngIf="propertiesEditMode" class="icon-size-5"
                                      [svgIcon]="'heroicons_solid:check'">
                                    </mat-icon>
                                  </button>
                                </div>
                                <!-- Available properties -->
                                <div class="
                                    max-h-40
                                    leading-none
                                    overflow-y-auto
                                    border-t
                                  ">
                                  <!-- properties -->
                                  <ng-container *ngIf="!propertiesEditMode">
                                    <ng-container *ngFor="
                                        let property of filteredProperties;
                                        trackBy: trackByFn
                                      ">
                                      <mat-checkbox class="
                                          flex
                                          items-center
                                          h-10
                                          min-h-10
                                          px-4
                                        " [color]="'primary'" [checked]="
                                          selectedProduct.properties.includes(
                                            property.id
                                          )
                                        " (change)="
                                          toggleProductProperty(
                                            property,
                                            $event
                                          )
                                        ">
                                        {{ property.name }}
                                      </mat-checkbox>
                                    </ng-container>
                                  </ng-container>
                                  <!-- Properties editing -->
                                  <ng-container *ngIf="propertiesEditMode">
                                    <div class="p-4 space-y-2">
                                      <ng-container *ngFor="
                                          let property of filteredProperties;
                                          trackBy: trackByFn
                                        ">
                                        <mat-form-field class="
                                            fuse-mat-dense fuse-mat-no-subscript
                                            w-full
                                          ">
                                          <input matInput [value]="property.name" (input)="
                                              updatePropertyName(
                                                property,
                                                $event
                                              )
                                            " />
                                          <button mat-icon-button (click)="deleteProperty(property)" matSuffix>
                                            <mat-icon class="icon-size-5" [svgIcon]="
                                                'heroicons_solid:trash'
                                              ">
                                            </mat-icon>
                                          </button>
                                        </mat-form-field>
                                      </ng-container>
                                    </div>
                                  </ng-container>
                                </div>
                                <div class="
                                    flex
                                    items-center
                                    h-10
                                    min-h-10
                                    -ml-0.5
                                    pl-4
                                    pr-3
                                    leading-none
                                    cursor-pointer
                                    border-t
                                    hover:bg-gray-50
                                    dark:hover:bg-hover
                                  " *ngIf="
                                    shouldShowCreatePropertyButton(
                                      newPropertyInput.value
                                    )
                                  " (click)="
                                    createProperty(newPropertyInput.value);
                                    newPropertyInput.value = ''
                                  " matRipple>
                                  <mat-icon class="mr-2 icon-size-5" [svgIcon]="'heroicons_solid:plus-circle'">
                                  </mat-icon>
                                  <div class="break-all">
                                    Create "<b>{{ newPropertyInput.value }}</b>"
                                  </div>
                                </div>
                              </div>
                            </ng-container>
                          </div>
                        </div>
                      </div>
                      <div class="
                          flex
                          items-center
                          justify-between
                          w-full
                          border-t
                          px-8
                          py-4
                        ">
                        <div class="flex items-center">
                          <div class="flex items-center mr-4" *ngIf="flashMessage">
                            <ng-container *ngIf="flashMessage === 'success'">
                              <mat-icon class="text-green-500" [svgIcon]="'heroicons_outline:check'"></mat-icon>
                              <span class="ml-2">Product updated</span>
                            </ng-container>
                            <ng-container *ngIf="flashMessage === 'error'">
                              <mat-icon class="text-red-500" [svgIcon]="'heroicons_outline:x'"></mat-icon>
                              <span class="ml-2">An error occurred, try again!</span>
                            </ng-container>
                          </div>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </ng-template>
            </ng-container>

            <tr class="shadow" mat-header-row *matHeaderRowDef="productsTableColumns; sticky: true"></tr>
            <tr class="h-18 hover:bg-gray-100 dark:hover:bg-hover" mat-row
              *matRowDef="let product; columns: productsTableColumns"></tr>
            <tr class="h-0" mat-row *matRowDef="let row; columns: ['productDetails']"></tr>
          </table>
        </div>
      </ng-container>

      <ng-template #noProducts>
        <div class="
            p-8
            sm:p-16
            border-t
            text-4xl
            font-semibold
            tracking-tight
            text-center
          ">
          There are no products!
        </div>
      </ng-template>
    </div>
  </div>
</div>